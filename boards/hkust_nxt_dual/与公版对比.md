## HKUST NXT-Dual vs 官方公版 PX4 固件差异

本文对比 `hkust_nxt-dual` 与官方公版参考固件（以 `px4_fmu-v6x_default` 代表的 Pixhawk/PX4 FMU 公版）差异，并说明意义。

### 官方公版基线
- 代表目标：`px4_fmu-v6x_default`（路径 `boards/px4/fmu-v6x`）。
- 硬件：STM32H753II（2MB，带以太网）、PX4IO 辅控、UAVCAN、电源监测、丰富 IMU/磁力计/气压计组合。
- 软件特征：以太网 MAVLink 预设、安全按钮、PX4IO 支持、UAVCAN/以太网驱动全开，支持多硬件变体自动探测。

### HKUST NXT-Dual 主要差异（表格对比）

| 维度 | hkust_nxt-dual | 公版 px4_fmu-v6x_default | 说明/意义 |
| --- | --- | --- | --- |
| MCU/Flash | STM32H743VI，2MB，无以太网 PHY；Bootloader 起始 `0x08020000`，APP 预留 128KB，14 段分区（`board_config.h`） | STM32H753II，2MB，含以太网 | H753 带以太网和更完整外设，适合高带宽应用 |
| 外设 | 无 PX4IO、无 UAVCAN、无以太网；直接 8 路 PWM | 含 PX4IO 辅控、UAVCAN、以太网 | 公版支持更多扩展（IO 安全、总线外设、网口） |
| 串口映射 | GPS1 `/dev/ttyS0`，GPS2 `/dev/ttyS2`，TELEM `/dev/ttyS1/S3/S6/S7`，RC `/dev/ttyS4`（`default.px4board`）；UART7/8 引脚定义见 `boards/hkust/nxt-dual/nuttx-config/include/board.h` | GPS2 `/dev/ttyS7`，RC `/dev/ttyS5`，含 EXT2、PX4IO | 布线和硬件外设不同，移植需重新映射 |
| 传感器 | 固定双 BMI088 + SPL06（`init/rc.board_sensors`） | 多型号 IMU/气压计/磁力计/电源监测自动探测 | hkust 配置固定且精简，公版通用性高 |
| 驱动集 | 精简：BMI088、SPL06、ADC、电调、RC、CDCACM 等 | 全量：PX4IO、UAVCAN、多 IMU、电源监测、以太网等 | hkust 体积小、依赖少；公版覆盖面广 |
| 默认参数 | 4S 分压/电流系数，`SYS_HAS_MAG=0`，`RC_INPUT_PROTO=-1`，`SYS_AUTOSTART=4001`，较高姿态速率增益（`rc.board_defaults`） | 主要配置 MAVLink 以太网和安全按钮，机型/传感器由用户选择 | hkust 针对小型四旋翼预调，换机架需重设 |
| Bootloader/USB | VID/PID `0x1B8C:0x0036`，字符串 `"HKUST UAV NxtPX4"` | Pixhawk 规范 VID/PID/字符串 | 量产/刷机需用对应 BL/描述符 |

### 使用与意义
- **定位**：`hkust_nxt-dual` 面向特定板卡，裁剪了以太网、PX4IO、UAVCAN 等高阶特性，换取更简单的外设与固定传感器组合。
- **移植工作量**：固件配置、Nuttx defconfig、启动脚本均已针对双 BMI088+SPL06 和对应串口布线预设，开箱即可飞；若迁移到公版 V6X，需重新映射串口、IMU、气压计并调整分压/增益。
- **生态兼容**：不兼容公版的以太网 MAVLink、PX4IO 工具链和 UAVCAN 外设；地面站/量产时需使用该板的 bootloader 与 USB 描述符。
- **参数/调参**：默认姿态增益较高（为小型四旋翼预调），若更换机架或电池倍率需先重置相关参数；公版则更多依赖机型模板选择。

### PX4IO 是什么
- **定义**：PX4IO 是主控外的协处理板，负责安全与 IO：RC 输入解码/冗余、输出级安全控制、混控执行（PWM/OneShot/DShot）、蜂鸣器/LED/安全开关管理等。
- **意义**：在主控异常或复位时保持电机输出安全态；隔离主控计算负载与实时 PWM；支持更多 RC 协议/输入容错。hkust_nxt-dual 未包含 PX4IO，因此 RC 输入与 PWM 直接由主控处理，安全功能依赖主控与参数配置。

### 以太网接口的作用
- **场景优势**：高带宽低时延链路，可同时跑 MAVLink 视频、ROS2 DDS、日志回传、远程 shell/调试；相比串口 921600/USB CDC，带宽和稳定性提升显著。
- **提升案例**：室内外高频位姿回传、相机/雷达时间同步、远程算法在地面侧实时闭环、远程 OTA/大体积日志下载。公版 V6X 启用以太网后可配置 MAVLink over UDP（`MAV_2_*` 相关参数），hkust_nxt-dual 无网口无法覆盖这些场景。

### UART7/8 定义位置
- 引脚定义：`boards/hkust/nxt-dual/nuttx-config/include/board.h` 中 `GPIO_UART7_RX/TX`（PE7/PE8）、`GPIO_UART8_RX/TX`（PE0/PE1）。
- Nuttx 使能与缓冲：`boards/hkust/nxt-dual/nuttx-config/nsh/defconfig` 中 `CONFIG_STM32H7_UART7=y`、`CONFIG_STM32H7_UART8=y`，并设置 `CONFIG_UART8_BAUD=57600`、`CONFIG_UART8_RXBUFSIZE=600`、`CONFIG_UART8_TXBUFSIZE=3000` 等。用途需在 `rc.board_defaults`/机型参数中映射到具体功能口（默认 `default.px4board` 未将 UART7/8 分配特定角色，可按布线自行启用）。
- NSH 控制台端口：`CONFIG_USART2_SERIAL_CONSOLE=y`，即 NSH/console 迁移到 USART2（TELEM1），波特率 `CONFIG_USART2_BAUD=115200`。UART8 虽启用但未绑定为控制台，默认波特率 57600，仅在手动映射后可作为外设/调试口。

### 结论
`hkust_nxt-dual` 是面向定制硬件的精简版 PX4 目标，核心区别在硬件外设裁剪、传感器固定配置和参数预调。公版 `px4_fmu-v6x_default` 侧重通用性与外设覆盖，包含以太网、PX4IO、UAVCAN 以及多 IMU/电源监测路径。选择目标时按实际硬件能力与所需外设决定：若需以太网/PX4IO/UAVCAN 生态与广泛外设，选公版；若使用 HKUST NXT-Dual 板并接受精简特性，选 `hkust_nxt-dual`.
