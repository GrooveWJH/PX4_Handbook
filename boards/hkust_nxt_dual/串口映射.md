## HKUST NXT-Dual 串口/接口映射速查

> 本文以 `archive/board_config/hkust#3`（2025-12-06）为示例，说明如何从 `.px4board`、`defconfig`、`board.h` 推导接口关系。将来若新增快照，只需在 `archive/` 中查看对应版本，本文无需修改。

目标：回答“.px4board 负责分配接口、defconfig 负责硬件映射”这件事，并给出 hkust_nxt-dual 的全部串口/Console/USB 关系。

### 角色分工
- **`default.px4board`**：PX4 层的“别名表”。把 `/dev/ttyS*` 这些设备映射成 `GPS1/GPS2/TEL* / RC` 等角色，PX4 各模块启动脚本会使用这些别名来决定在哪个口启动 MAVLink、GPS 驱动等。
- **`nuttx-config/nsh/defconfig`**：Nuttx 层的硬件配置。决定 MCU 上哪些 UART/USART 被编译进来（`CONFIG_STM32H7_USARTx`/`UARTx`），指定波特率、DMA/缓存，以及控制台归属（`CONFIG_USART6_SERIAL_CONSOLE` 等）。
- **`nuttx-config/include/board.h`**：引脚和外设复用表。告诉 Nuttx “USART1 = PA9/PA10”、“UART8 = PE0/PE1”等，也包含 I2C/SPI/LED 引脚。

理解了三者关系，就能追踪任何接口从 PCB 焊盘 → MCU 外设 → `/dev/ttyS*` → PX4 角色的完整路径。

### 串口/接口映射表

| PX4 角色 (`default.px4board`) | `/dev/ttyS*` 节点 | MCU 外设 & 引脚（`board.h`） | Nuttx 配置 (`defconfig`) | 快照 #2 用途 |
| --- | --- | --- | --- | --- |
| GPS1 | `/dev/ttyS0` | USART1：TX=PA9，RX=PA10 | `CONFIG_STM32H7_USART1=y`，`CONFIG_USART1_BAUD=57600` | 主 GPS 口；rc.sensors 里默认不会自动启动，需要根据传感器类型配置 |
| GPS2 | `/dev/ttyS2` | USART3：TX=PD8，RX=PD9 | `CONFIG_STM32H7_USART3=y`，`CONFIG_USART3_BAUD=57600` | 备用 GPS/RTK |
| TELEM1 | `/dev/ttyS1` | USART2：TX=PD5，RX=PD6 | `CONFIG_STM32H7_USART2=y` | 默认运行 uXRCE-DDS（`UXRCE_DDS_CFG=101`，`SER_TEL1_BAUD=921600`） |
| TELEM2 | `/dev/ttyS3` | UART4：TX=PB9，RX=PB8 | `CONFIG_STM32H7_UART4=y`，`CONFIG_UART4_BAUD=921600`，带 RX/TX DMA | 默认用于串行测距仪（`SENS_TFMINI_CFG=102`，运行在 `SER_TEL2_BAUD=115200`），如需其它用途先禁用对应驱动 |
| TELEM3 | `/dev/ttyS6` | UART7：TX=PE8，RX=PE7 | `CONFIG_STM32H7_UART7=y`，`CONFIG_UART7_BAUD=57600` | 可作额外 MAVLink/调试口，默认未被脚本使用 |
| TELEM4 / NSH Console | `/dev/ttyS7` | UART8：TX=PE1，RX=PE0 | `CONFIG_STM32H7_UART8=y`，`CONFIG_UART8_SERIAL_CONSOLE=y`，`CONFIG_UART8_BAUD=921600`，`RX/TX BUFSIZE=2048/4096` | 固定作为 NSH 控制台（921600 baud）；若需给 MAVLink/其它外设，可改 `defconfig` 并重新编译 |
| RC 输入 | `/dev/ttyS4` | UART5：TX=PB13，RX=PB12 | `CONFIG_STM32H7_UART5=y`，`CONFIG_UART5_BAUD=57600` | 用于 SBUS/DSM 等串口遥控输入，配合 `RC_INPUT_PROTO` 参数 |
| 备用调试口 | `/dev/ttyS5` | USART6：TX=PC6，RX=PC7 | `CONFIG_STM32H7_USART6=y`，`CONFIG_USART6_BAUD=57600` | 早期版本的 NSH Console，现在默认空闲，可自行映射成次级调试/UART |
| USB-C CDC | `/dev/ttyACM0` | STM32 OTG FS + CDC ACM (`CONFIG_CDCACM_*`) | `CONFIG_CDCACM` 启用，`CONFIG_NSH_USBCONSOLE` 关闭 | Bootloader + MAVLink (`cdcacm_autostart`)，不再承载 NSH |

> `/dev/ttyS*` ↔ MCU 外设的对应关系可在旧版 `old_defconfig.txt` 的注释（`#ttyS0` 等）以及 PX4 STM32 驱动里找到；表格展示了这一映射在快照 #2 下的实例。新的快照若调整串口角色，只需按照同样的方法推导即可。

> `Nuttx defconfig` 现已改为 `CONFIG_UART8_SERIAL_CONSOLE=y`，NSH 通过 UART8 (`/dev/ttyS7`) 输出；USB CDC 仅用于 MAVLink/Bootloader，与 `SER_TEL*` 参数无关。
### 如何调整/验证
- **想把 NSH 改到 UART8**：在 `defconfig` 中改为 `CONFIG_USART6_SERIAL_CONSOLE=n`、`CONFIG_UART8_SERIAL_CONSOLE=y`（或 `CONFIG_USART8_SERIAL_CONSOLE` 取决于驱动名称），重新 `make hkust_nxt-dual_default` 即可。PX4 层无需改，除非你还想让某个 MAVLink 口改绑。
- **想让 UART8 承担 MAVLink/外设**：在 PX4 参数或 `rc.board_defaults` 中把 `MAV_{0,1}_CONFIG` 改成使用 `/dev/ttyS7`，或者修改 `default.px4board` 将 `CONFIG_BOARD_SERIAL_TEL*` 指向 `/dev/ttyS7`。
- **判断一个接口功能**：沿着 “`.px4board` 别名 → `/dev/ttyS*` 节点 → `defconfig` 波特率/console → `board.h` 引脚” 这条链，就能定位硬件端口和固件设置，确认是否需要改动。

## 快照与方法并行

1. **先看快照**：`archive/board_config/hkust#N/default.px4board` 提供当前固件的别名表；如果只想知道“本版本 TELEM1 指向哪个 `/dev/ttyS*`”，查快照最快。
2. **再看方法**：当需要修改或移植到其它板时，沿着上文“角色分工”推导，确保 `.px4board`、`defconfig`、`board.h` 三处保持一致。
3. **保持手册稳定**：即便将来 TELEM1/2 被重新分配，只要在 `archive/` 中新增 `hkust#3` 并记录差异，本文描述的方法仍然适用。

通过这种“快照 + 方法”的组合，既能快速核对 PCB 丝印与固件设置，又能在需要调整时按部就班地修改 `.px4board` 与 `defconfig`，避免因为某次改动就重写整篇文档。***
