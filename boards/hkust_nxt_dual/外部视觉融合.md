# PX4 外部视觉 (EV) 融合与坐标原点对齐机制

本文面向使用 `/fmu/in/vehicle_visual_odometry` 或 MAVLink `ODOMETRY` 向 PX4 提供动捕/VIO 数据的开发者，解析 PX4 EKF2 的融合逻辑、原点管理、以及当外部视觉原点与 PX4 NED 原点不一致时的行为。文内引用 PX4 v1.17 源码文件与行号（commit `3e1c499d5ddb`）以便查证。

## 1. EKF2 如何订阅 `vehicle_visual_odometry`

- `src/modules/ekf2/EKF2.hpp` 第 330 行：`uORB::Subscription _ev_odom_sub{ORB_ID(vehicle_visual_odometry)};` 表示 EKF2 后端订阅该话题。
- `src/modules/ekf2/EKF2.cpp` 第 2207 行起：`_ev_odom_sub.update(&_ev_odom)` 将 ROS/MAVLink 输入存入 `extVisionSample` 缓冲。
- `src/modules/ekf2/EKF/estimator_interface.cpp` 第 372~395 行：将外部视觉样本推入 `_ext_vision_buffer`，并限制频率，避免过快更新。
- `src/modules/ekf2/EKF/aid_sources/external_vision/ev_control.cpp` 第 47~97 行：从缓冲中取样，并调用 `EvPosControl` / `EvVelControl` / `EvYawControl` 进行融合。

## 2. `EKF2_EV_CTRL` 位掩码与参数

参数定义位于 `src/modules/ekf2/params_external_vision.yaml`：

- bit0：水平位置融合
- bit1：垂直位置融合
- bit2：速度融合
- bit3：航向 (Yaw) 融合

你的配置 `EKF2_EV_CTRL=11 (0b1011)` → 启用水平位置、垂直位置、Yaw；未启用速度融合。若希望 EKF 重置局部速度到外部视觉，还需打开 bit2。

其他关键参数：

- `EKF2_EV_DELAY`：EV 数据相对于 IMU 的延迟（ms）。
- `EKF2_EV_POS_X/Y/Z`：EV 传感器相对机体系的固定偏移。
- `EKF2_EV_QMIN`：最小质量指标，低于阈值不融合。

## 3. 外部视觉坐标与 PX4 NED 原点的关系

### 3.1 EKF2 的 NED 原点固定在启动位置

- `vehicle_local_position` 的说明（`msg/versioned/VehicleLocalPosition.msg`）指出：“坐标系原点是 EKF 启动时的车辆位置”。
- EKF2 启动时将 `ref_lat/lon/alt` 及本地原点锁定，除非主动 reset。

### 3.2 外部视觉融合不自动改变原点

- `ev_pos_control.cpp` 第 224~289 行：当外部视觉位姿可用时，EKF 会根据创新（残差）决定是否 `reset_pos_to_vision`。**reset 只是把 EKF 估计的 `x/y/z` 对齐到视觉观测，但不会更改 `ref_lat/lon` 原点位置**。因此如果动捕原点不同，EKF 会把视觉位置减去自身原点偏置后作为测量值。
- 这就是为什么在 MAVLink Inspector 中看到的 `LOCAL_POSITION_NED` 与动捕数值不一致：EKF 内部仍以自己的原点表示位置。

### 3.3 如何让原点对齐动捕？

- `EKF2_EV_CTRL` bit3 (Yaw) + `EKF2_EV_POS_*` + `EKF2_EV_DELAY` 只是指定融合内容，**不会自动重定位原点**。
- 要显式对齐，有两种方式：
  1. 在动捕数据稳定后触发 EKF reset（`param set EKF2_EV_CTRL <包含 bit0/1>` 并等待 `_information_events.flags.reset_pos_to_vision` 为 true，或在 NSH 执行 `ekf2 reset`）。
  2. 在外部视觉节点中减去 PX4 的原点偏置（`vehicle_local_position.ref_lat/lon`, `x`, `y`, `z`）使得发送的 `position` 与 PX4 NED 原点一致。
- 源码参考：`event_flags.reset_pos_to_vision` 发布在 `src/modules/ekf2/EKF2.cpp` 第 1157~1166 行，通过 `estimator_event_flags_s` 告知上层“已将位置重置到视觉”。

## 4. 为什么 `vehicle_visual_odometry` 不立刻覆盖 `vehicle_local_position`？

- EKF2 仍需综合 IMU、GPS、Baro 等观测；`EV` 只是新增的观测源。`ev_pos_control.cpp` 中的逻辑：
  - 若 EV 位置与 EKF 估计差异大且满足条件，设置 `_information_events.flags.reset_pos_to_vision=true`，这种 `reset` 由 `ekf2_innovation_test_ratio` 触发。
  - 若差异较小，则仅作为常规观测修正状态，不会跳变。
- 因此 `vehicle_local_position` 会逐步向 EV 数据收敛，但仍保持原点不变。

## 5. 同步/融合延迟与质量

- `EV_MAX_INTERVAL` (200ms) 定义在 `src/modules/ekf2/EKF/common.h` 第 72 行：若超过该时间未收到新 EV 数据，EKF 会停止融合（`information_event_flags.starting_vision_*` 变 false）。
- `ev_yaw_control.cpp`, `ev_vel_control.cpp`, `ev_height_control.cpp` 中分别控制航向、速度、高度观测的启停。
- 在你的代码里，`position_variance=0.05`，`quality=100`，EKF 会将其作为 `extVisionSample.quality` 传入，满足 `EKF2_EV_QMIN` 后即可融合。

## 6. 推荐操作流程

1. **确保时间戳和坐标系**：`pose_frame=POSE_FRAME_NED`，`timestamp` 精确到 microseconds；`reset_counter` 可保持 0。
2. **在 PX4 启动后立即发送动捕数据**，允许 EKF 尽早 reset 至视觉。
3. **监控 EKF 事件**：
   - `listener estimator_status_flags` 或 QGC EKF 层显示 `vision position` / `vision yaw` 标志为 true。
   - `listener estimator_event_flags` 查看 `reset_pos_to_vision`、`starting_vision_pos_fusion` 等状态。
4. **若需要原点一致**，可：
   - 通过 NSH `ekf2 reset` 或参数 `COM_OBS_AVOID=1` 手动触发；
   - 或在外部节点中使用 PX4 返回的 `vehicle_local_position` 原点值，将动捕数据转换到 PX4 的 NED 原点再发送。
5. **考虑开启速度融合 (EKF2_EV_CTRL bit2)**：否则 EKF 的速度仍依赖 IMU/GPS，可能造成位置长期漂移。

## 7. `vehicle_mocap_odometry` 的区别

- 主要用于 MAVLink/ROS 透传，不被 EKF2 订阅（`EKF2.hpp` 中仅订阅 `vehicle_visual_odometry`）。
- 如果你向 `/fmu/in/vehicle_mocap_odometry` 发布数据，PX4 会通过 MAVLink 转发，但 EKF 不使用。

## 8. 参考链接

- 源码路径：`src/modules/ekf2/EKF/aid_sources/external_vision/*.cpp`。
- MAVLink/ROS2 概述：见 `PX4_Handbook/core/px4_position_topics.md`。
- EKF2 参数文档：`src/modules/ekf2/params_external_vision.yaml`。

---

**总结**：
- 在 `vehicle_visual_odometry` 提供的动捕坐标与 PX4 NED 原点不重合时，EKF2 会把两者差异当作观测残差，只要条件满足会进行 `reset_pos_to_vision`；否则就逐步融合，不会瞬间覆盖。
- 若希望 EKF 坐标完全对齐外部视觉，需要主动 reset 或把动捕坐标转换为 PX4 本地原点。
- 参数 `EKF2_EV_CTRL`, `EKF2_EV_DELAY`, `EKF2_EV_POS_*` 等控制融合模式与延迟；`vehicle_mocap_odometry` 并不参与 EKF 融合。
