## HKUST NXT-Dual 串口/接口映射速查

目标：回答“.px4board 负责分配接口、defconfig 负责硬件映射”这件事，并给出 hkust_nxt-dual 的全部串口/Console/USB 关系。

### 角色分工
- **`default.px4board`**：PX4 层的“别名表”。把 `/dev/ttyS*` 这些设备映射成 `GPS1/GPS2/TEL* / RC` 等角色，PX4 各模块启动脚本会使用这些别名来决定在哪个口启动 MAVLink、GPS 驱动等。
- **`nuttx-config/nsh/defconfig`**：Nuttx 层的硬件配置。决定 MCU 上哪些 UART/USART 被编译进来（`CONFIG_STM32H7_USARTx`/`UARTx`），指定波特率、DMA/缓存，以及控制台归属（`CONFIG_USART6_SERIAL_CONSOLE` 等）。
- **`nuttx-config/include/board.h`**：引脚和外设复用表。告诉 Nuttx “USART1 = PA9/PA10”、“UART8 = PE0/PE1”等，也包含 I2C/SPI/LED 引脚。

理解了三者关系，就能追踪任何接口从 PCB 焊盘 → MCU 外设 → `/dev/ttyS*` → PX4 角色的完整路径。

### 串口/接口映射表

| PX4 角色 (`default.px4board`) | `/dev/ttyS*` 节点 | MCU 外设 & 引脚（`board.h`） | Nuttx 配置 (`defconfig`) | 默认用途/备注 |
| --- | --- | --- | --- | --- |
| GPS1 | `/dev/ttyS0` | USART1：TX=PA9，RX=PA10 | `CONFIG_STM32H7_USART1=y`，`CONFIG_USART1_BAUD=57600` | 主 GPS 口；rc.sensors 里默认不会自动启动，需要根据传感器类型配置 |
| GPS2 | `/dev/ttyS2` | USART3：TX=PD8，RX=PD9 | `CONFIG_STM32H7_USART3=y`，`CONFIG_USART3_BAUD=57600` | 备用 GPS/RTK |
| TELEM1 | `/dev/ttyS1` | USART2：TX=PD5，RX=PD6 | `CONFIG_STM32H7_USART2=y`，`CONFIG_USART2_SERIAL_CONSOLE=y` | 现用作 NuttX/NSH 控制台（默认 115200）；不再跑 MAVLink |
| TELEM2 | `/dev/ttyS3` | UART4：TX=PB9，RX=PB8 | `CONFIG_STM32H7_UART4=y`，`CONFIG_UART4_BAUD=921600`，带 RX/TX DMA | 默认运行 uXRCE-DDS（`UXRCE_DDS_CFG=102`，`SER_TEL2_BAUD=115200`），若要接测距仪请先把 XRCE 改到其他口 |
| TELEM3 | `/dev/ttyS6` | UART7：TX=PE8，RX=PE7 | `CONFIG_STM32H7_UART7=y`，`CONFIG_UART7_BAUD=57600` | 可作额外 MAVLink/调试口，默认未被脚本使用 |
| TELEM4 | `/dev/ttyS7` | UART8：TX=PE1，RX=PE0 | `CONFIG_STM32H7_UART8=y`，`CONFIG_UART8_BAUD=57600` | 默认空闲，可在参数中把 `UXRCE_DDS_CFG` 或 `MAV_*_CONFIG` 改到此口 |
| RC 输入 | `/dev/ttyS4` | UART5：TX=PB13，RX=PB12 | `CONFIG_STM32H7_UART5=y`，`CONFIG_UART5_BAUD=57600` | 用于 SBUS/DSM 等串口遥控输入，配合 `RC_INPUT_PROTO` 参数 |
| 备用调试口 | `/dev/ttyS5` | USART6：TX=PC6，RX=PC7 | `CONFIG_STM32H7_USART6=y`，`CONFIG_USART6_BAUD=57600` | 早期版本的 NSH Console，现在默认空闲，可自行映射成次级调试/UART |
| USB-C CDC | `/dev/ttyACM0` | STM32 OTG FS + CDC ACM (`CONFIG_CDCACM_*`) | `CONFIG_DRIVERS_CDCACM_AUTOSTART=y` | 默认跑 MAVLink/参数/刷写，非 console，需另行启动 NSH 映射才可直接进 shell |

> `/dev/ttyS*` ↔ MCU 外设的对应关系可在旧版 `old_defconfig.txt` 的注释（`#ttyS0` 等）以及 PX4 STM32 驱动里找到；当前表格基于该标准顺序（USART1→ttyS0，USART2→ttyS1，…，UART8→ttyS7）。

### 如何调整/验证
- **想把 NSH 改到 UART8**：在 `defconfig` 中改为 `CONFIG_USART6_SERIAL_CONSOLE=n`、`CONFIG_UART8_SERIAL_CONSOLE=y`（或 `CONFIG_USART8_SERIAL_CONSOLE` 取决于驱动名称），重新 `make hkust_nxt-dual_default` 即可。PX4 层无需改，除非你还想让某个 MAVLink 口改绑。
- **想让 UART8 承担 MAVLink/外设**：在 PX4 参数或 `rc.board_defaults` 中把 `MAV_{0,1}_CONFIG` 改成使用 `/dev/ttyS7`，或者修改 `default.px4board` 将 `CONFIG_BOARD_SERIAL_TEL*` 指向 `/dev/ttyS7`。
- **判断一个接口功能**：沿着 “`.px4board` 别名 → `/dev/ttyS*` 节点 → `defconfig` 波特率/console → `board.h` 引脚” 这条链，就能定位硬件端口和固件设置，确认是否需要改动。

通过该表，你可以快速核对 PCB 丝印（标称 UART 编号/用途）与 PX4 固件实际配置是否一致，避免出现“硬件标注 DEBUG，但固件未使用”的情况。需要新增角色时，也只需同步修改 `.px4board` 和 `defconfig`，其余 PX4 模块即可复用这些别名。***
